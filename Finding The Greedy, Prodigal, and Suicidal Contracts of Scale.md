# Finding The Greedy, Prodigal, and Suicidal Contracts at Scale

## 概述

在本篇论文中，研究人员提出了一种称之为跟踪漏洞的漏洞的系统特征。在此次研究中，不像之前的工作使用动态和静态分析来自动发现漏洞，此次研究中我们通过使用一系列合约调用来实现对于漏洞的寻找。

研究人员将漏洞合约标记为三类，greedy,prodigal,and suicidal。对于三种合约解释为无限期锁死合约中的资金，将资金泄露给任何人，以及有被任何人kill掉的嫌疑。

## Prodigal Contract

合同通常会将资金返回给账户的所有者（部署资金的账户）、过去向其发送过以太币的地址（例如，彩票） ，或是显示出特定解决方法的地址（例如，奖金）。而对于一个合约可以将资金转发给任何地址，我们称其为挥霍合约（即，prodigal contract)。

## Suicidal Contract

合同允许在紧急情况下（如果由于攻击而耗尽其以太币，或者是出现故障的时候），合同是允许被其拥有者或可信地址kill掉的安全后备项。。若一个合约能够被任意的地址给kill掉的话，那么我们将合约称之为suicidal contract。

## Greedy Contract

我们将那些在任何情况下都可以被释放的合约，始终保持存在以及会将资金锁死在合约中的合约称之为Greedy contract。也许这样的解释不够清楚，在Parity Contract的例子中，许多类multisigWallet的合约回去调用Parity中的转账函数来实现对于用户的转账。但是如果一旦Parity library被销毁，那么必定会导致multisigWallet中的资金被锁死在合约中，这样的一个漏洞导致了价值两亿美金的以太币锁死。

## Posthumous Contract

当一个合约被销毁，他的代码和相关全局变量都是会从区块链上删除掉的，从而防止了其代码的后续执行。然而，所有的被销毁的合约是会继续接受交易的。尽管这样的交易不会在调用合约中的代码，但是如果以太币被发送给相关合约的时候，合约的balance(余额)会增加。但是由于函数的无法调用，也就是意味着send,call,transfer这些指令是不存在的，那么也就意味着合约中的以太币被锁死。。所以我们将不含有代码的被销毁的合约，且合约中的以太币不为零的合约称之为遗赠合约。

## 实验中使用的方法

值得注意的是，在先前的工作中已经考虑了作为一个调用属性的bug，忽略了调用跟踪中的效果链。Maian就是通过系统化的方法来发现合约中所违反的指定的追踪属性。

这个漏洞属性一般将其分为两种：安全属性（safety property)，活性属性（liveness property)。安全属性：可以确定存在来自特定区块中的状态会导致合同违反给定的条件。活性属性：意味着从特定区块链开始到结束不会被采取进入执行的程序。

Maian作为一项技术主要由两部分构成：符号分析和具体验证。

### 符号分析

符号分析的部分将合约字节码以及分析规范作为输入。分析规范包括需要查找的漏洞种类和搜索空间的深度（我们进一步将其称为调用深度）。并且为了开发符号分析这一部分内容，我们实现了一个定制化的EVM，这个虚拟机可以刚好的促进合约字节码的符号执行。对于每个合约，符号分析都会符号化地运行可能的执行追踪，直到找到一组满足预定属性的追踪。对于每个执行追踪所输入的上下文，均视为一组符号变量。如果一旦一个合约被标记，组件会返回符号变量的具体值。从而可以进入具体验证组件。

### 具体验证

具体验证的组件使用有符号分析组件生成的内容作为输入，并且检查在以太坊区块链的私有分支上的使用情况。本质上，就是一个用来确认bug正确性的试验台环境。最后结果，在验证之后，合约会被确认为真阳性或是假阳性，但是在主链上的状态不变（因为没有任何的变化被传递到主链上）。

## Trace Vulnerabilities(追踪漏洞)

我们上面所提到的三种漏洞类型是可以通过执行追踪的方式进行利用的，并且这三种漏洞也是属于两种标准类型。两种标准类型分别是：针对某种不受欢迎的高级场景的合同缺陷（如果合约中的执行路径无法满足某个确定的条件，就会触发相关漏洞）；第二类是与合约相关的，在合约中，要证明没有其他高级bug，就需要建立一种不同类型的声明，即"好事情终将发生"（即预想到的情况会出现），需要对于合约的执行进度进行推理。

### EVM Semantics and Traces

对于每个合约，区块链必定存储三个重要信息：balance(代表合约中ether存储的余额)，code(用字节码指定合约的程序逻辑)，storage(用来存储合约全局变量)

其中对于代码域的话是不可变的，一旦一个合约被部署到区块链上，其逻辑就无法被更新了。

对于storage field的话则是可变的，EVM字节码很容易改变合约的storage

一个合约的余额是可以被任何人读取的，一个合约的余额发生的情况要么就是call to or from other contract.